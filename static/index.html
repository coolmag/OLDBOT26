<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Aurora –°–í–ï–ú–ê</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --bg: #111; --cyan: #00f3ff; --pink: #ff0055; --btn-bg: #222; }
        body { background-color: var(--bg); background-image: radial-gradient(circle at center, #222 0%, #000 100%); color: #fff; font-family: 'Courier New', monospace; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        /* –°–û–í–ï–¢–°–ö–ê–Ø –ö–ê–°–°–ï–¢–ê –°–í–ï–ú–ê –ú–ö-60 */
        .cassette {
            width: 340px; height: 210px; background: #e8e8e6; /* –ë–µ–ª—ã–π/—Å–µ—Ä—ã–π –ø–ª–∞—Å—Ç–∏–∫ */
            border-radius: 12px; position: relative;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.2), 0 25px 50px rgba(0,0,0,0.9);
            border: 2px solid #ccc; border-bottom: 6px solid #bbb;
            display: flex; flex-direction: column; align-items: center; padding: 15px; transition: transform 0.2s;
            /* –†–∏—Ñ–ª–µ–Ω—ã–µ –∫—Ä–∞—è –ø–ª–∞—Å—Ç–∏–∫–∞ */
            background-image: repeating-linear-gradient(90deg, transparent, transparent 15px, rgba(0,0,0,0.03) 15px, rgba(0,0,0,0.03) 20px);
        }

        /* –í–∏–Ω—Ç–∏–∫–∏ */
        .screw { position: absolute; width: 14px; height: 14px; background: #ddd; border-radius: 50%; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.3), 0 1px 1px #fff; border: 1px solid #aaa; }
        .screw::before, .screw::after { content: ''; position: absolute; top: 50%; left: 15%; width: 70%; height: 2px; background: #777; }
        .screw::before { transform: translateY(-50%) rotate(45deg); } .screw::after { transform: translateY(-50%) rotate(-45deg); }
        .tl { top: 10px; left: 10px; } .tr { top: 10px; right: 10px; } .bl { bottom: 10px; left: 10px; } .br { bottom: 10px; right: 10px; }

        /* –ù–∞–∫–ª–µ–π–∫–∞ */
        .label {
            width: 95%; height: 130px; background: #fdfdfd; border-radius: 6px; position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05), 0 1px 3px rgba(0,0,0,0.2);
            border: 1px solid #ddd; display: flex; flex-direction: column; align-items: center; overflow: hidden;
        }

        /* –î–∏–∑–∞–π–Ω –°–≤–µ–º–∞ */
        .svema-logo { position: absolute; top: 12px; left: 15px; border: 2px solid #d00; color: #d00; padding: 2px 6px; font-family: serif; font-weight: bold; font-size: 14px; border-radius: 4px; letter-spacing: 1px; }
        .red-lines { position: absolute; top: 18px; right: 15px; width: 50%; height: 8px; border-top: 2px solid #d00; border-bottom: 2px solid #d00; }
        
        .black-block {
            position: absolute; top: 45px; width: 100%; height: 50px; background: #1a1a1a;
            display: flex; justify-content: center; align-items: center; box-shadow: inset 0 2px 5px #000;
        }

        .green-block {
            position: absolute; bottom: 8px; width: 90%; height: 22px; background: #9dbca6;
            display: flex; justify-content: space-between; align-items: center; padding: 0 10px;
            color: #d00; font-family: sans-serif; font-weight: 900; font-size: 16px; border: 1px solid #8ba894;
        }

        /* –û–∫–æ—à–∫–æ —Å –ø–ª–µ–Ω–∫–æ–π */
        .window {
            width: 200px; height: 35px; background: rgba(255,255,255,0.8); border-radius: 4px;
            border: 2px solid #555; display: flex; justify-content: space-between; align-items: center;
            padding: 0 15px; position: relative; box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
        }
        .spool { width: 28px; height: 28px; background: #f0f0f0; border-radius: 50%; border: 3px solid #111; position: relative; box-shadow: 0 0 4px #000; }
        /* –ó—É–±—á–∏–∫–∏ –≤ –∫–∞—Ç—É—à–∫–µ */
        .spool::after {
            content: ''; position: absolute; inset: 0;
            background: conic-gradient(transparent 10%, #333 10% 20%, transparent 20% 40%, #333 40% 50%, transparent 50% 70%, #333 70% 80%, transparent 80%);
            border-radius: 50%; animation: spin 2s linear infinite; animation-play-state: paused;
        }
        .playing .spool::after { animation-play-state: running; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .bridge { width: 70px; height: 26px; background: #000; position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); border-radius: 2px; opacity: 0.9; }

        /* –¢–µ–∫—Å—Ç —Ç—Ä–µ–∫–∞ (–ü–æ–≤–µ—Ä—Ö –∫–∞—Å—Å–µ—Ç—ã) */
        .info { margin-top: -15px; text-align: center; width: 100%; z-index: 5; background: rgba(0,0,0,0.8); padding: 5px 0; border-radius: 4px; margin-bottom: 20px; border: 1px solid #333;}
        .title { color: var(--cyan); font-weight: 900; font-size: 16px; text-transform: uppercase; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; padding: 0 10px;}
        .artist { font-size: 13px; color: #aaa; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; padding: 0 10px;}

        /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
        .progress-wrapper { width: 100%; max-width: 340px; height: 6px; background: #222; border-radius: 3px; overflow: hidden; border: 1px solid #333; }
        .progress-fill { width: 0%; height: 100%; background: var(--cyan); box-shadow: 0 0 10px var(--cyan); transition: width 0.1s linear; }

        /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
        .main-controls { margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; width: 100%; }
        .btn {
            background: var(--btn-bg); border: 2px solid #111; color: #aaa; font-family: 'Courier New', monospace;
            font-weight: 900; font-size: 16px; padding: 12px 14px; cursor: pointer;
            box-shadow: 0 4px 0 #000, 0 5px 5px rgba(0,0,0,0.5); border-radius: 6px; transition: all 0.1s;
        }
        .btn:active { transform: translateY(4px); box-shadow: 0 0 0 #000, inset 0 2px 5px rgba(0,0,0,0.5); color: #fff; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 0 4px 0 #000; }
        .play-btn { color: var(--cyan); border-color: #004444; min-width: 80px; }
        .playing .play-btn { color: var(--pink); border-color: #440011; text-shadow: 0 0 8px var(--pink); box-shadow: 0 4px 0 #000, 0 0 15px rgba(255,0,85,0.3); }

        /* –ü–æ–∏—Å–∫ */
        .search-box { margin-top: 20px; width: 100%; max-width: 340px; display: flex; justify-content: center; }
        input {
            background: #000; border: 2px solid #333; color: var(--cyan); font-family: 'Courier New', monospace; font-weight: bold;
            padding: 12px; width: 100%; text-transform: uppercase; outline: none; text-align: center;
            border-radius: 6px; box-shadow: inset 0 0 10px rgba(0,243,255,0.1); transition: border-color 0.3s;
        }
        input:focus { border-color: var(--cyan); }
        input::placeholder { color: #555; font-weight: normal; }

        /* –ú–µ–Ω—é (Drawers) */
        .drawer-container { position: fixed; inset: 0; z-index: 100; pointer-events: none; }
        .overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(3px); opacity: 0; transition: opacity 0.3s; }
        .drawer {
            position: absolute; bottom: 0; left: 0; right: 0; height: 70vh; background: #111;
            border-radius: 20px 20px 0 0; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 1, 0.5, 1);
            display: flex; flex-direction: column; padding: 20px; border-top: 2px solid var(--cyan); box-shadow: 0 -10px 40px rgba(0,243,255,0.1);
        }
        #drawer-title { margin: 0; color: var(--cyan); text-shadow: 0 0 5px var(--cyan); text-transform: uppercase; }
        #drawer-content { overflow-y: auto; color: #fff; padding-bottom: 20px; }
        .drawer-container.active { pointer-events: all; } .drawer-container.active .overlay { opacity: 1; } .drawer-container.active .drawer { transform: translateY(0); }
        
        .menu-item, .playlist-item {
            padding: 14px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 10px;
            cursor: pointer; transition: all 0.2s; border-left: 3px solid transparent;
        }
        .menu-item:hover, .playlist-item:hover { background: rgba(255,255,255,0.1); border-left-color: var(--cyan); }
        .playlist-item.active { background: rgba(255,0,85,0.15); border-left-color: var(--pink); color: var(--pink); font-weight: bold; }

        /* –ú–æ–¥–∞–ª–∫–∞ –ò–ò */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 200; display: flex; flex-direction: column;
            justify-content: center; align-items: center; gap: 15px; padding: 20px; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; backdrop-filter: blur(5px);
        }
        .modal.active { opacity: 1; pointer-events: all; }
    </style>
</head>
<body>

    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞ –≤—ã–Ω–µ—Å–µ–Ω–æ –∏–∑ –∫–∞—Å—Å–µ—Ç—ã, —á—Ç–æ–±—ã —Ç–µ–∫—Å—Ç –Ω–µ –ø–ª—ã–ª -->
    <div class="info">
        <span class="title" id="title">–ù–ï–¢ –ö–ê–°–°–ï–¢–´</span>
        <span class="artist" id="artist">–í–°–¢–ê–í–¨–¢–ï –ü–õ–ï–ù–ö–£</span>
    </div>

    <!-- –ö–∞—Å—Å–µ—Ç–∞ –°–í–ï–ú–ê -->
    <div class="cassette" id="deck">
        <div class="screw tl"></div><div class="screw tr"></div><div class="screw bl"></div><div class="screw br"></div>
        <div class="label">
            <div class="svema-logo">–°–≤–µ–º–∞</div>
            <div class="red-lines"></div>
            
            <div class="black-block">
                <div class="window"><div class="spool"></div><div class="bridge"></div><div class="spool"></div></div>
            </div>

            <div class="green-block">
                <span>–ú–ö-60-5</span>
                <span style="color:#333; font-size:12px;">1991</span>
            </div>
        </div>
    </div>

    <div class="progress-wrapper" style="margin-top:20px;"><div class="progress-fill" id="progress-fill"></div></div>

    <div class="main-controls">
        <button class="btn" id="btn-prev" onclick="app.player.prev()">‚óÄ‚óÄ</button>
        <button class="btn play-btn" id="playBtn" onclick="app.player.toggle()">–ü–£–°–ö</button>
        <button class="btn" id="btn-next" onclick="app.player.next()">‚ñ∂‚ñ∂</button>
        <button class="btn" onclick="app.ui.toggleDrawer('playlist')">‚ò∞</button>
        <button class="btn" onclick="app.ui.toggleDrawer('genres')">‚ô™</button>
        <button class="btn" onclick="app.ui.toggleAIModal(true)">ü§ñ</button>
    </div>

    <!-- –û–±–µ—Ä–Ω—É—Ç–æ –≤ —Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–ª–∞–≤–∏—à–∏ Enter -->
    <form class="search-box" onsubmit="app.search(); return false;">
        <input type="text" id="query" placeholder="–ü–û–ò–°–ö –ò–õ–ò –ò–ò...">
    </form>

    <!-- –ú–µ–Ω—é —Å –∫—Ä–µ—Å—Ç–∏–∫–æ–º -->
    <div id="drawer-container" class="drawer-container">
        <div class="overlay" id="overlay-bg"></div>
        <div id="drawer" class="drawer">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid rgba(0,243,255,0.2); padding-bottom: 10px;">
                <h3 id="drawer-title"></h3>
                <button onclick="app.ui.toggleDrawer()" style="background:none; border:none; color:#fff; font-size:36px; cursor:pointer; line-height:0.5;">&times;</button>
            </div>
            <div id="drawer-content"></div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ –ò–ò –æ–±–µ—Ä–Ω—É—Ç–∞ –≤ —Ñ–æ—Ä–º—É –¥–ª—è —Ä–∞–±–æ—Ç—ã Enter -->
    <form id="ai-modal" class="modal" onsubmit="app.askAI(); return false;">
        <h3 style="color:var(--cyan); margin-bottom: 0;">–ò–ò –î–ò–î–ñ–ï–ô</h3>
        <input type="text" id="ai-input" placeholder="–ß–¢–û –í–ö–õ–Æ–ß–ò–¢–¨?">
        <div style="display:flex; gap:10px;">
            <button type="submit" class="btn play-btn" id="ai-btn">–í–†–£–ë–ê–ô</button>
            <button type="button" class="btn" onclick="app.ui.toggleAIModal(false)">–û–¢–ú–ï–ù–ê</button>
        </div>
    </form>

    <script>
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.ready();
        }

        const app = {
            store: {
                _s: { p: [], ci: -1 },
                _l: {},
                sub(event, callback) { this._l[event] = this._l[event] || []; this._l[event].push(callback); },
                _n(event, data) { if (this._l[event]) this._l[event].forEach(cb => cb(data)); },
                set(newState) {
                    Object.assign(this._s, newState);
                    if (newState.p) this._n("p", this._s.p);
                    if (newState.ci !== undefined) this._n("t", this._s.p[this._s.ci]);
                }
            },
            
            api: {
                _b: window.location.origin,
                async _f(endpoint) {
                    const res = await fetch(`${this._b}${endpoint}`);
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    return res.json();
                },
                search: (q) => app.api._f(`/api/player/playlist?query=${encodeURIComponent(q)}`),
                askAI: (q) => app.api._f(`/api/ai/dj?prompt=${encodeURIComponent(q)}`)
            },
            
            player: {
                audio: new Audio(),
                init() {
                    this.audio.addEventListener("ended", () => this.next());
                    this.audio.addEventListener("timeupdate", () => app.ui.updateProgress(this.audio.currentTime, this.audio.duration));
                    this.audio.addEventListener("play", () => app.ui.setPlayState(true));
                    this.audio.addEventListener("pause", () => app.ui.setPlayState(false));
                    this.audio.addEventListener("error", () => {
                        app.ui.showError("–û–®–ò–ë–ö–ê –ü–õ–ï–ù–ö–ò");
                        setTimeout(() => { if (app.store._s.p.length > 1) this.next(); }, 2000);
                    });
                },
                play(track) {
                    if (!track) return;
                    app.ui.updateTrackInfo(track);
                    this.audio.src = `${app.api._b}/stream/${track.identifier}`;
                    this.audio.play();
                },
                toggle() {
                    if (this.audio.src) {
                        this.audio.paused ? this.audio.play() : this.audio.pause();
                    }
                },
                next() {
                    if (app.store._s.p.length === 0) return;
                    let i = app.store._s.ci + 1;
                    if (i >= app.store._s.p.length) i = 0;
                    app.store.set({ ci: i });
                    this.play(app.store._s.p[i]);
                },
                prev() {
                    if (app.store._s.p.length === 0) return;
                    if (this.audio.currentTime > 3) {
                        this.audio.currentTime = 0;
                    } else {
                        let i = app.store._s.ci - 1;
                        if (i < 0) i = app.store._s.p.length - 1;
                        app.store.set({ ci: i });
                        this.play(app.store._s.p[i]);
                    }
                }
            },
            
            ui: {
                get: (id) => document.getElementById(id),
                _dr: null,
                setPlayState(isPlaying) {
                    this.get("deck").classList.toggle("playing", isPlaying);
                    this.get("playBtn").innerText = isPlaying ? "–°–¢–û–ü" : "–ü–£–°–ö";
                },
                updateTrackInfo(track) {
                    if (track) {
                        this.get("title").innerText = track.title || "–ù–ï–ò–ó–í–ï–°–¢–ù–û";
                        this.get("artist").innerText = track.artist || track.uploader || "–ù–ï–ò–ó–í–ï–°–¢–ù–û";
                    }
                },
                showError(msg) {
                    this.get("title").innerText = msg;
                    this.get("artist").innerText = "";
                    this.setPlayState(false);
                },
                setLoading(isLoading) {
                    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ –≤–æ –≤—Ä–µ–º—è –∑–∞–≥—Ä—É–∑–∫–∏, —á—Ç–æ–±—ã –Ω–µ –Ω–∞–∫–ª–∏–∫–∞–ª–∏
                    this.get("playBtn").disabled = isLoading;
                    this.get("btn-next").disabled = isLoading;
                    this.get("btn-prev").disabled = isLoading;
                    if (isLoading) {
                        this.get("title").innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
                        this.get("artist").innerText = "–û–ñ–ò–î–ê–ô–¢–ï...";
                    }
                },
                updateProgress(current, total) {
                    if (total > 0) {
                        const percent = (current / total) * 100;
                        this.get("progress-fill").style.width = `${percent}%`;
                    }
                },
                toggleDrawer(drawerType) {
                    const container = this.get("drawer-container");
                    if (this._dr && this._dr === drawerType) {
                        this._dr = null; 
                    } else {
                        this._dr = drawerType; 
                    }
                    if (this._dr) {
                        container.classList.add("active");
                        this.get("drawer-title").textContent = this._dr === "playlist" ? "–û–ß–ï–†–ï–î–¨ –¢–†–ï–ö–û–í" : "–ñ–ê–ù–†–´";
                        this.renderDrawer();
                    } else {
                        container.classList.remove("active");
                    }
                },
                renderDrawer() {
                    const content = this.get("drawer-content");
                    content.innerHTML = "";
                    if (this._dr === "playlist") {
                        if (app.store._s.p.length === 0) content.innerHTML = "<div style='text-align:center;color:#666'>–ö–ê–°–°–ï–¢–ê –ü–£–°–¢–ê</div>";
                        app.store._s.p.forEach((track, i) => {
                            const div = document.createElement("div");
                            div.className = "playlist-item" + (i === app.store._s.ci ? " active" : "");
                            div.textContent = `${track.title} - ${track.artist || track.uploader}`;
                            div.onclick = () => {
                                app.store.set({ ci: i });
                                app.player.play(track);
                                this.toggleDrawer();
                            };
                            content.appendChild(div);
                        });
                    } else if (this._dr === "genres") {
                        app.genres.forEach(genre => {
                            const div = document.createElement("div");
                            div.className = "menu-item";
                            div.textContent = genre.n;
                            div.onclick = () => {
                                app.search(genre.q);
                                this.toggleDrawer();
                            };
                            content.appendChild(div);
                        });
                    }
                },
                toggleAIModal(show) { this.get("ai-modal").classList.toggle("active", show); }
            },
            
            genres: [
                { n: "üåç –ú–∏—Ä–æ–≤—ã–µ —Ö–∏—Ç—ã", q: "top pop hits 2024" },
                { n: "üé∏ –†–æ–∫ –ª–µ–≥–µ–Ω–¥—ã", q: "classic rock 70s" },
                { n: "üéß –î—Ä–∏—Ñ—Ç –§–æ–Ω–∫", q: "drift phonk mix" },
                { n: "üá∑üá∫ –†—É—Å—Å–∫–∞—è –ø–æ–ø—Å–∞", q: "—Ä—É—Å—Å–∫–∏–µ —Ö–∏—Ç—ã 2024" },
                { n: "‚ú® –ß–∏–ª–ª / –†–∞–±–æ—Ç–∞", q: "deep focus music" },
                { n: "üé≤ –ú–Ω–µ –ø–æ–≤–µ–∑–µ—Ç", q: "top hits mix" }
            ],
            
            async search(queryStr) {
                const q = (typeof queryStr === 'string') ? queryStr : this.ui.get("query").value;
                if (!q) return;
                
                this.ui.setLoading(true); // –í–∫–ª—é—á–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..."
                
                try {
                    const res = await this.api.search(q);
                    if (res.playlist && res.playlist.length > 0) {
                        this.store.set({ p: res.playlist, ci: 0 });
                        this.player.play(res.playlist[0]);
                    } else { this.ui.showError("–ù–ï –ù–ê–ô–î–ï–ù–û"); }
                } catch (e) { this.ui.showError("–û–®–ò–ë–ö–ê –°–ï–¢–ò"); }
                finally { this.ui.setLoading(false); }
            },
            
            async askAI() {
                const q = this.ui.get("ai-input").value;
                if (!q) return;
                
                // ‚ö†Ô∏è –í–ê–ñ–ù–û: –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º Web Speech API —Å—Ä–∞–∑—É –ø–æ –∫–ª–∏–∫—É, –¥–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.resume();
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(''));
                }

                this.ui.toggleAIModal(false);
                this.ui.setLoading(true); // –í–∫–ª—é—á–∞–µ–º "–ó–∞–≥—Ä—É–∑–∫–∞..."
                
                try {
                    const res = await this.api.askAI(q);
                    
                    // –û–∑–≤—É—á–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò
                    if (res.message && 'speechSynthesis' in window) {
                        window.speechSynthesis.cancel();
                        const utterance = new SpeechSynthesisUtterance(res.message);
                        utterance.lang = 'ru-RU';
                        utterance.rate = 1.1;
                        window.speechSynthesis.speak(utterance);
                    }
                    
                    if (res.playlist && res.playlist.length > 0) {
                        this.store.set({ p: res.playlist, ci: 0 });
                        this.player.play(res.playlist[0]);
                    } else { this.ui.showError("–ù–ï –ù–ê–ô–î–ï–ù–û –ò–ò"); }
                } catch (e) { this.ui.showError("–û–®–ò–ë–ö–ê –ò–ò"); }
                finally { this.ui.setLoading(false); }
            },
            
            init() {
                this.player.init();
                this.store.sub("t", track => this.ui.updateTrackInfo(track));
                this.store.sub("p", () => { if (this.ui._dr) this.ui.renderDrawer(); });
                this.ui.get("overlay-bg").onclick = () => this.ui.toggleDrawer();
            }
        };

        document.addEventListener("DOMContentLoaded", () => app.init());
    </script>
</body>
</html>